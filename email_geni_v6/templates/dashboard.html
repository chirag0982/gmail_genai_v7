{% extends "base.html" %}

{% block title %}Dashboard - AI Email Assistant{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">Welcome back, {{ user.first_name or user.email.split('@')[0] }}!</h1>
                <p class="text-muted mb-0">Here's your email productivity overview</p>
            </div>
            <div>
                <a href="{{ url_for('compose') }}" class="btn btn-primary">
                    <i data-feather="edit"></i> New Email
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                            <i data-feather="mail" class="text-primary"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="fw-bold h4 mb-0">{{ analytics.total_emails or 0 }}</div>
                        <div class="text-muted small">Total Emails</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-success bg-opacity-10 rounded-circle p-3">
                            <i data-feather="send" class="text-success"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="fw-bold h4 mb-0">{{ analytics.sent_emails or 0 }}</div>
                        <div class="text-muted small">Emails Sent</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                            <i data-feather="clock" class="text-warning"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="fw-bold h4 mb-0">{{ (analytics.avg_generation_time_ms / 1000) | round(1) or 0 }}s</div>
                        <div class="text-muted small">Avg Generation Time</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i data-feather="star" class="text-info"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="fw-bold h4 mb-0">{{ analytics.avg_user_rating or 'N/A' }}</div>
                        <div class="text-muted small">Avg Rating</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Pending Invitations -->
    {% if pending_invitations %}
    <div class="col-12 mb-4">
        <div class="alert alert-info d-flex align-items-center" role="alert">
            <i data-feather="mail" class="me-2"></i>
            <div class="flex-grow-1">
                <strong>You have {{ pending_invitations|length }} pending team invitation{{ 's' if pending_invitations|length != 1 else '' }}</strong>
                <button class="btn btn-sm btn-outline-info ms-2" data-bs-toggle="modal" data-bs-target="#invitationsModal">
                    View Invitations
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Emails -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Emails</h5>
                    <a href="{{ url_for('compose') }}" class="btn btn-sm btn-outline-primary">
                        <i data-feather="plus"></i> New Email
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                {% if recent_emails %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>AI Model</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for email in recent_emails %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i data-feather="mail" class="me-2 text-muted"></i>
                                        <div>
                                            <div class="fw-medium">{{ email.subject or 'No Subject' }}</div>
                                            {% if email.to_addresses %}
                                            <small class="text-muted">To: {{ email.to_addresses | join(', ') }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% set status_class = {
                                        'draft': 'secondary',
                                        'sent': 'success',
                                        'delivered': 'info',
                                        'opened': 'primary',
                                        'replied': 'warning',
                                        'failed': 'danger'
                                    } %}
                                    <span class="badge bg-{{ status_class.get(email.status.value, 'secondary') }}">
                                        {{ email.status.value.title() }}
                                    </span>
                                </td>
                                <td>
                                    {% if email.ai_model_used %}

                                            <small class="text-muted">
                                            AI Model: {% if email.ai_model_used %}{{ email.ai_model_used.value.replace('-', ' ').title() }}{% else %}N/A{% endif %}
                                        </small>

                                    {% else %}
                                    <small class="text-muted">Manual</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                        {% if email.created_at %}
                            {{ email.created_at.strftime('%m/%d %H:%M') }}
                        {% else %}
                            Unknown
                        {% endif %}
                    </small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        {% if email.status.value == 'draft' %}
                                        <a href="{{ url_for('compose') }}?edit={{ email.id }}" class="btn btn-outline-primary btn-sm" title="Edit Draft">
                                            <i data-feather="edit-2"></i>
                                        </a>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteDraft('{{ email.id }}')" title="Delete Draft">
                                            <i data-feather="trash-2"></i>
                                        </button>
                                        {% else %}
                                        <button class="btn btn-outline-secondary btn-sm" onclick="viewEmail('{{ email.id }}')" title="View Email">
                                            <i data-feather="eye"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i data-feather="mail" class="text-muted mb-3" style="width: 48px; height: 48px;"></i>
                    <h6 class="text-muted">No emails yet</h6>
                    <p class="text-muted">Start by composing your first AI-powered email!</p>
                    <a href="{{ url_for('compose') }}" class="btn btn-primary">
                        <i data-feather="edit"></i> Compose Email
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quick Actions & Teams -->
    <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h6 class="mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('compose') }}" class="btn btn-primary">
                        <i data-feather="edit"></i> Compose Email
                    </a>
                    <a href="{{ url_for('templates') }}" class="btn btn-outline-secondary">
                        <i data-feather="file-text"></i> Browse Templates
                    </a>
                    <a href="{{ url_for('analytics') }}" class="btn btn-outline-info">
                        <i data-feather="bar-chart-2"></i> View Analytics
                    </a>
                    <a href="{{ url_for('settings') }}" class="btn btn-outline-warning">
                        <i data-feather="settings"></i> Email Settings
                    </a>
                </div>
            </div>
        </div>

        <!-- Teams -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">My Teams</h6>
                    <a href="{{ url_for('team') }}" class="btn btn-sm btn-outline-primary">
                        <i data-feather="plus"></i> Join/Create
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if teams %}
                <div class="list-group list-group-flush">
                    {% for team in teams %}
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-primary bg-opacity-10 rounded-circle p-2">
                                    <i data-feather="users" class="text-primary"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-medium">{{ team.name }}</div>
                                <small class="text-muted">{{ team.members | length }} members</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i data-feather="users" class="text-muted mb-2"></i>
                    <p class="text-muted mb-0 small">No teams yet</p>
                    <a href="{{ url_for('team') }}" class="small">Create or join a team</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- AI Model Usage Chart -->
{% if analytics.model_usage %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h6 class="mb-0">AI Model Usage (Last 30 Days)</h6>
            </div>
            <div class="card-body">
                <canvas id="modelUsageChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}
<!-- Email View Modal -->
<div class="modal fade" id="viewEmailModal" tabindex="-1" aria-labelledby="viewEmailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewEmailModalLabel">Email Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="emailViewContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading email...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Invitations Modal -->
{% if pending_invitations %}
<div class="modal fade" id="invitationsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Team Invitations</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% for invitation in pending_invitations %}
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title">{{ invitation.team.name }}</h6>
                                <p class="card-text text-muted">{{ invitation.team.description or 'No description provided' }}</p>
                                <small class="text-muted">
                                    Invited by: {{ invitation.invited_by.first_name or invitation.invited_by.email.split('@')[0] }}
                                    <br>
                                    Role: <span class="badge bg-secondary">{{ invitation.role.value.title() }}</span>
                                    <br>
                                    {{ invitation.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                </small>
                                {% if invitation.message %}
                                <div class="mt-2">
                                    <small><strong>Message:</strong> {{ invitation.message }}</small>
                                </div>
                                {% endif %}
                            </div>
                            <div class="btn-group-vertical" role="group">
                                <button type="button" class="btn btn-sm btn-success" 
                                        onclick="respondToInvitation('{{ invitation.id }}', 'accept')"
                                        data-invitation-id="{{ invitation.id }}"
                                        data-action="accept">
                                    <i data-feather="check"></i> Accept
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                        onclick="respondToInvitation('{{ invitation.id }}', 'decline')"
                                        data-invitation-id="{{ invitation.id }}"
                                        data-action="decline">
                                    <i data-feather="x"></i> Decline
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Toast notification function
function showToast(message, type = 'info') {
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }

    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div class="toast" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="text-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} me-2" data-feather="${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info'}"></i>
                <strong class="me-auto">${type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Info'}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">${message}</div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();

    if (typeof feather !== 'undefined') {
        feather.replace();
    }

    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

// Team invitation response handler - rebuilt from scratch
async function respondToInvitation(invitationId, response) {
    if (!invitationId || !response) {
        showToast('Invalid invitation data', 'error');
        return;
    }

    if (!['accept', 'decline'].includes(response)) {
        showToast('Invalid response type', 'error');
        return;
    }

    try {
        console.log('Processing invitation response:', { invitationId, response });

        const requestData = {
            invitation_id: invitationId,
            response: response
        };

        const fetchResponse = await fetch('/api/respond-invitation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(requestData)
        });

        if (!fetchResponse.ok) {
            throw new Error(`HTTP ${fetchResponse.status}: ${fetchResponse.statusText}`);
        }

        const result = await fetchResponse.json();

        if (result.success) {
            const actionText = response === 'accept' ? 'accepted' : 'declined';
            showToast(result.message || `Invitation ${actionText} successfully!`, 'success');
            
            // Wait a moment then reload to update the page
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showToast(result.error || 'Failed to process invitation', 'error');
        }

    } catch (error) {
        console.error('Error processing invitation:', error);
        showToast('Network error: ' + error.message, 'error');
    }
}

// Delete draft function
async function deleteDraft(emailId) {
    if (!confirm('Are you sure you want to delete this draft? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/delete-draft/${emailId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();

        if (result.success) {
            showToast(result.message || 'Draft deleted successfully!', 'success');
            // Reload the page to update the list
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showToast(result.error || 'Failed to delete draft', 'error');
        }
    } catch (error) {
        console.error('Error deleting draft:', error);
        showToast('Network error: ' + error.message, 'error');
    }
}

// Function to view email details
async function viewEmail(emailId) {
    try {
        // Create modal if it doesn't exist (similar to app.js approach)
        let modalElement = document.getElementById('viewEmailModal');
        if (!modalElement) {
            modalElement = document.createElement('div');
            modalElement.id = 'viewEmailModal';
            modalElement.className = 'modal fade';
            modalElement.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Email Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="emailViewContent">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modalElement);
        }

        const modal = new bootstrap.Modal(modalElement);
        modal.show();

        // Show loading state
        document.getElementById('emailViewContent').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading email...</p>
            </div>
        `;

        const response = await fetch(`/api/get-email/${emailId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();

        if (result.success) {
            const email = result.email;
            const statusBadgeClass = {
                'draft': 'secondary',
                'sent': 'success',
                'delivered': 'info',
                'opened': 'primary',
                'replied': 'warning',
                'failed': 'danger'
            };

            document.getElementById('emailViewContent').innerHTML = `
                <div class="email-details">
                    <!-- Email Header -->
                    <div class="border-bottom pb-3 mb-3">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="fw-bold mb-2">${email.subject || 'No Subject'}</h6>
                                <div class="small text-muted">
                                    <div><strong>From:</strong> ${email.from_address || 'N/A'}</div>
                                    <div><strong>To:</strong> ${email.to_addresses ? email.to_addresses.join(', ') : 'N/A'}</div>
                                    ${email.cc_addresses && email.cc_addresses.length > 0 ? `<div><strong>CC:</strong> ${email.cc_addresses.join(', ')}</div>` : ''}
                                    ${email.bcc_addresses && email.bcc_addresses.length > 0 ? `<div><strong>BCC:</strong> ${email.bcc_addresses.join(', ')}</div>` : ''}
                                </div>
                            </div>
                            <div class="col-md-4 text-md-end">
                                <span class="badge bg-${statusBadgeClass[email.status] || 'secondary'} mb-2">
                                    ${email.status.charAt(0).toUpperCase() + email.status.slice(1)}
                                </span>
                                <div class="small text-muted">
                                    <div><strong>Created:</strong> ${email.created_at ? new Date(email.created_at).toLocaleString() : 'Unknown'}</div>
                                    ${email.sent_at ? `<div><strong>Sent:</strong> ${new Date(email.sent_at).toLocaleString()}</div>` : ''}
                                    ${email.ai_model_used ? `<div><strong>AI Model:</strong> ${email.ai_model_used.replace('_', ' ').replace('-', ' ')}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Email Body -->
                    <div class="email-body">
                        <h6 class="mb-3">Email Content:</h6>
                        <div class="border rounded p-3" style="background-color: var(--bs-light);">
                            ${email.body_html ? email.body_html : (email.body_text ? `<pre style="white-space: pre-wrap; font-family: inherit;">${email.body_text}</pre>` : '<em class="text-muted">No content available</em>')}
                        </div>
                    </div>

                    ${email.original_email ? `
                    <div class="mt-4">
                        <h6 class="mb-3">Original Email (Being Replied To):</h6>
                        <div class="border rounded p-3" style="background-color: var(--bs-secondary-bg);">
                            <pre style="white-space: pre-wrap; font-family: inherit; font-size: 0.9em;">${email.original_email}</pre>
                        </div>
                    </div>
                    ` : ''}

                    ${email.context ? `
                    <div class="mt-4">
                        <h6 class="mb-3">Additional Context:</h6>
                        <div class="border rounded p-3" style="background-color: var(--bs-info-bg-subtle);">
                            <pre style="white-space: pre-wrap; font-family: inherit; font-size: 0.9em;">${email.context}</pre>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        } else {
            document.getElementById('emailViewContent').innerHTML = `
                <div class="alert alert-danger">
                    <i data-feather="alert-circle"></i>
                    Error loading email: ${result.error || 'Unknown error'}
                </div>
            `;
            feather.replace();
        }

    } catch (error) {
        console.error('Error viewing email:', error);
        document.getElementById('emailViewContent').innerHTML = `
            <div class="alert alert-danger">
                <i data-feather="alert-circle"></i>
                Network error while loading email details
            </div>
        `;
        feather.replace();
    }
}

// Function to delete email
async function deleteEmail(emailId) {
    if (!confirm('Are you sure you want to delete this email? This action cannot be undone.')) {
        return;
    }
    try {
        const response = await fetch(`/api/delete-email/${emailId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        const result = await response.json();
        if (result.success) {
            alert('Email deleted successfully!');
            window.location.reload(); // Reload the page to reflect the deletion
        } else {
            alert(`Error deleting email: ${result.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error deleting email:', error);
        alert('Network error while deleting email.');
    }
}

// Function to delete draft
async function deleteDraft(emailId) {
    if (!confirm('Are you sure you want to delete this draft? This action cannot be undone.')) {
        return;
    }
    try {
        const response = await fetch(`/api/delete-draft/${emailId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        const result = await response.json();
        if (result.success) {
            showToast('Draft deleted successfully!', 'success');
            // Remove the row from the table
            const row = document.querySelector(`button[onclick="deleteDraft('${emailId}')"]`).closest('tr');
            if (row) {
                row.remove();
            }
            // Reload page after short delay to update counts
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast(`Error deleting draft: ${result.error || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        console.error('Error deleting draft:', error);
        showToast('Network error while deleting draft', 'error');
    }
}

// Initialize page functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize feather icons
    feather.replace();
    
    // Test that respondToInvitation function is available
    console.log('respondToInvitation function available:', typeof window.respondToInvitation === 'function');
    
    // Add backup event listeners for invitation buttons in case onclick fails
    document.querySelectorAll('[data-invitation-id]').forEach(button => {
        button.addEventListener('click', function(e) {
            const invitationId = this.getAttribute('data-invitation-id');
            const action = this.getAttribute('data-action');
            
            if (invitationId && action) {
                e.preventDefault();
                window.respondToInvitation(invitationId, action);
            }
        });
    });
    
    // View email buttons
    document.querySelectorAll('.view-email-btn').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            const emailId = this.getAttribute('data-email-id');
            viewEmail(emailId);
        });
    });
});
</script>
{% endblock %}