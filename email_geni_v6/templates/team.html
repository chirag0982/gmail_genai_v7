{% extends "base.html" %}

{% block title %}Team Management - AI Email Assistant{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">Team Management</h1>
                <p class="text-muted mb-0">Manage your teams and collaborate on email projects</p>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTeamModal">
                <i data-feather="plus"></i> Create Team
            </button>
        </div>
    </div>
</div>

<!-- Teams Grid -->
<div class="row g-4">
    {% if teams %}
    {% for team_data in teams %}
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">{{ team_data.team.name }}</h5>
                        <small class="text-muted">
                            <span class="badge bg-{{ 'danger' if team_data.role.value == 'admin' else 'primary' if team_data.role.value == 'manager' else 'secondary' }}">
                                {{ team_data.role.value.title() }}
                            </span>
                        </small>
                    </div>

                    {% if team_data.role.value in ['admin', 'manager'] %}
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                data-bs-toggle="dropdown">
                            <i data-feather="settings"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="#" 
                                   onclick="editTeam('{{ team_data.team.id }}', '{{ team_data.team.name }}', '{{ team_data.team.description or '' }}')">
                                    <i data-feather="edit-2"></i> Edit Team
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" 
                                   onclick="inviteMember('{{ team_data.team.id }}')">
                                    <i data-feather="user-plus"></i> Invite Member
                                </a>
                            </li>
                            {% if team_data.role.value == 'admin' %}
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" 
                                   onclick="deleteTeam('{{ team_data.team.id }}')">
                                    <i data-feather="trash-2"></i> Delete Team
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card-body">
                {% if team_data.team.description %}
                <p class="text-muted mb-3">{{ team_data.team.description }}</p>
                {% endif %}

                <!-- Team Stats -->
                <div class="row g-2 mb-3">
                    <div class="col-4">
                        <div class="text-center">
                            <div class="h5 mb-0 text-primary">{{ team_data.members|length }}</div>
                            <small class="text-muted">Members</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-center">
                            <div class="h5 mb-0 text-success">{{ team_data.team.ai_model_access|length }}</div>
                            <small class="text-muted">AI Models</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-center">
                            <div class="h5 mb-0 text-warning">{{ (team_data.team.monthly_token_limit / 1000)|round(1) }}K</div>
                            <small class="text-muted">Token Limit</small>
                        </div>
                    </div>
                </div>

                <!-- AI Models Access -->
                <div class="mb-3">
                    <h6 class="small text-muted mb-2">Available AI Models</h6>
                    <div class="d-flex flex-wrap gap-1">
                        {% for model in team_data.team.ai_model_access %}
                        <span class="badge bg-info">{{ model.replace('-', ' ').title() }}</span>
                        {% endfor %}
                    </div>
                </div>

                <!-- Team Members -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="small text-muted mb-0">Team Members</h6>
                        {% if team_data.role.value in ['admin', 'manager'] %}
                        <button class="btn btn-xs btn-outline-primary" 
                                onclick="inviteMember('{{ team_data.team.id }}')">
                            <i data-feather="user-plus"></i>
                        </button>
                        {% endif %}
                    </div>

                    <div class="list-group list-group-flush">
                        {% for member in team_data.members[:5] %}
                        <div class="list-group-item border-0 px-0 py-1">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    {% if member.user.profile_image_url %}
                                    <img src="{{ member.user.profile_image_url }}" alt="Profile" 
                                         class="rounded-circle me-2" width="24" height="24" style="object-fit: cover;">
                                    {% else %}
                                    <div class="bg-secondary bg-opacity-25 rounded-circle me-2 d-flex align-items-center justify-content-center" 
                                         style="width: 24px; height: 24px;">
                                        <i data-feather="user" style="width: 12px; height: 12px;"></i>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <div class="small fw-medium">
                                            {{ member.user.first_name or member.user.email.split('@')[0] }}
                                        </div>
                                        <div class="text-muted" style="font-size: 11px;">
                                            {{ member.user.email }}
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center gap-1">
                                    <span class="badge bg-{{ 'danger' if member.role.value == 'admin' else 'primary' if member.role.value == 'manager' else 'secondary' }} badge-sm">
                                        {{ member.role.value.title() }}
                                    </span>
                                    {% if team_data.role.value == 'admin' and member.user.id != current_user.id %}
                                    <div class="dropdown">
                                        <button class="btn btn-xs btn-outline-secondary dropdown-toggle" 
                                                data-bs-toggle="dropdown">
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a class="dropdown-item" href="#" 
                                                   onclick="changeMemberRole('{{ member.id }}', '{{ member.user.first_name or member.user.email.split('@')[0] }}')">
                                                    <i data-feather="edit-2"></i> Change Role
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item text-danger" href="#" 
                                                   onclick="removeMember('{{ member.id }}', '{{ member.user.first_name or member.user.email.split('@')[0] }}')">
                                                    <i data-feather="user-minus"></i> Remove
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        {% if team_data.members|length > 5 %}
                        <div class="text-center mt-3">
                            <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="toggleAllMembers('{{ team_data.team.id }}')">
                                <span id="toggleText{{ team_data.team.id }}">Show All Members</span>
                            </button>
                        </div>
                        {% endif %}

                        <!-- Pending Invitations -->
                        {% if team_data.pending_invitations %}
                        <div class="border-top mt-3 pt-3">
                            <h6 class="text-muted mb-3">
                                <i data-feather="clock"></i> Pending Invitations ({{ team_data.pending_invitations|length }})
                            </h6>
                            {% for invitation in team_data.pending_invitations %}
                            <div class="d-flex align-items-center justify-content-between mb-2 p-2 bg-light rounded">
                                <div class="d-flex align-items-center">
                                    <div class="bg-warning bg-opacity-25 rounded-circle me-3 d-flex align-items-center justify-content-center" 
                                         style="width: 32px; height: 32px;">
                                        <i data-feather="clock" style="width: 16px; height: 16px;"></i>
                                    </div>
                                    <div>
                                        <div class="fw-medium">{{ invitation.invited_user.first_name or invitation.invited_user.email.split('@')[0] }}</div>
                                        <small class="text-muted">
                                            {{ invitation.invited_user.email }} • {{ invitation.role.value.title() }}
                                            <br>Invited {{ invitation.created_at.strftime('%b %d') }}
                                        </small>
                                    </div>
                                </div>
                                {% if team_data.role.value == 'admin' or invitation.invited_by_id == user.id %}
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="cancelInvitation('{{ invitation.id }}', '{{ invitation.invited_user.first_name or invitation.invited_user.email.split('@')[0] }}')">
                                    <i data-feather="x"></i>
                                </button>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card-footer bg-light border-top">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        Created {{ team_data.team.created_at.strftime('%b %d, %Y') }}
                    </small>
                    <div class="d-flex gap-1">
                        <a href="{{ url_for('compose') }}?team={{ team_data.team.id }}" 
                           class="btn btn-sm btn-outline-primary">
                            <i data-feather="edit"></i> Compose
                        </a>
                        <a href="{{ url_for('analytics') }}?team={{ team_data.team.id }}" 
                           class="btn btn-sm btn-outline-info">
                            <i data-feather="bar-chart-2"></i> Analytics
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i data-feather="users" class="text-muted mb-3" style="width: 64px; height: 64px;"></i>
                <h5 class="text-muted">No Teams Yet</h5>
                <p class="text-muted mb-4">Create your first team to start collaborating on emails with others.</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTeamModal">
                    <i data-feather="plus"></i> Create Your First Team
                </button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Create/Edit Team Modal -->
<div class="modal fade" id="createTeamModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teamModalTitle">Create New Team</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="teamForm">
                <div class="modal-body">
                    <input type="hidden" id="teamId" name="team_id">

                    <div class="mb-3">
                        <label for="teamName" class="form-label">Team Name</label>
                        <input type="text" class="form-control" id="teamName" name="name" required>
                    </div>

                    <div class="mb-3">
                        <label for="teamDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="teamDescription" name="description" rows="3" 
                                  placeholder="Brief description of the team's purpose"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Team</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Invite Member Modal -->
<div class="modal fade" id="inviteMemberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Invite Team Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="inviteForm">
                <div class="modal-body">
                    <input type="hidden" id="inviteTeamId" name="team_id">

                    <div class="mb-3">
                        <label for="memberEmail" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="memberEmail" name="email" required>
                    </div>

                    <div class="mb-3">
                        <label for="memberRole" class="form-label">Role</label>
                        <select class="form-select" id="memberRole" name="role" required>
                            {% for role in user_roles %}
                            <option value="{{ role.value }}" {{ 'selected' if role.value == 'user' else '' }}>
                                {{ role.value.title() }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <small>
                                <strong>Admin:</strong> Full access including team management<br>
                                <strong>Manager:</strong> Can manage templates and view analytics<br>
                                <strong>User:</strong> Can compose and send emails<br>
                                <strong>Viewer:</strong> Read-only access
                            </small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Invitation</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Role Modal -->
<div class="modal fade" id="changeRoleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Member Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="changeRoleForm">
                <div class="modal-body">
                    <input type="hidden" id="changeMemberId" name="member_id">

                    <p>Change role for <strong id="changeMemberName"></strong>:</p>

                    <div class="mb-3">
                        <label for="newRole" class="form-label">New Role</label>
                        <select class="form-select" id="newRole" name="role" required>
                            {% for role in user_roles %}
                            <option value="{{ role.value }}">{{ role.value.title() }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Role</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Confirmation Modals -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmModalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Global variables for confirmation actions
window.currentAction = null;
window.currentActionData = null;

document.addEventListener('DOMContentLoaded', function() {
    const teamForm = document.getElementById('teamForm');
    const inviteForm = document.getElementById('inviteForm');
    const changeRoleForm = document.getElementById('changeRoleForm');

    // Team form submission
    teamForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        try {
            const formData = new FormData(teamForm);
            const data = Object.fromEntries(formData.entries());

            const response = await fetch('/api/create-team', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                showToast('Team created successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('createTeamModal')).hide();

                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast('Error creating team: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Network error while creating team', 'error');
        }
    });

    // Invite form submission
    inviteForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        try {
            const formData = new FormData(inviteForm);
            const data = Object.fromEntries(formData.entries());

            const response = await fetch('/api/invite-member', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                showToast('Invitation sent successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('inviteMemberModal')).hide();
            } else {
                showToast('Error sending invitation: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Network error while sending invitation', 'error');
        }
    });

    // Change role form submission
    changeRoleForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        try {
            const formData = new FormData(changeRoleForm);
            const data = Object.fromEntries(formData.entries());

            const response = await fetch('/api/change-member-role', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                showToast('Member role updated successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('changeRoleModal')).hide();

                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast('Error updating role: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Network error while updating role', 'error');
        }
    });

    // Confirm action handler
    document.getElementById('confirmActionBtn').addEventListener('click', async function() {
        if (!window.currentAction || !window.currentActionData) {
            console.error('No action or data set for confirmation');
            return;
        }

        try {
            let response;
            let endpoint = '';
            let bodyData = {};

            if (window.currentAction === 'deleteTeam') {
                endpoint = '/api/delete-team';
                bodyData = { team_id: window.currentActionData };
            } else if (window.currentAction === 'removeMember') {
                endpoint = '/api/remove-member';
                bodyData = { member_id: window.currentActionData };
            } else if (window.currentAction === 'cancelInvitation') {
                endpoint = '/api/cancel-invitation';
                bodyData = { invitation_id: window.currentActionData };
            } else {
                console.error('Unknown action:', window.currentAction);
                return;
            }

            console.log('Performing action:', window.currentAction, 'with data:', window.currentActionData);

            response = await fetch(endpoint, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bodyData)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                showToast(result.message || 'Action completed successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();

                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast('Error: ' + (result.error || 'Unknown error'), 'error');
                bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            }
        } catch (error) {
            console.error('Error performing action:', error);
            showToast('Network error while performing action: ' + error.message, 'error');
            bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
        } finally {
            window.currentAction = null;
            window.currentActionData = null;
        }
    });
});

// Global functions for modal triggers
function editTeam(teamId, name, description) {
    document.getElementById('teamId').value = teamId;
    document.getElementById('teamName').value = name;
    document.getElementById('teamDescription').value = description;
    document.getElementById('teamModalTitle').textContent = 'Edit Team';

    new bootstrap.Modal(document.getElementById('createTeamModal')).show();
}

function inviteMember(teamId) {
    document.getElementById('inviteTeamId').value = teamId;
    new bootstrap.Modal(document.getElementById('inviteMemberModal')).show();
}

function changeMemberRole(memberId, memberName) {
    document.getElementById('changeMemberId').value = memberId;
    document.getElementById('changeMemberName').textContent = memberName;

    new bootstrap.Modal(document.getElementById('changeRoleModal')).show();
}

function deleteTeam(teamId) {
    document.getElementById('confirmModalTitle').textContent = 'Delete Team';
    document.getElementById('confirmModalMessage').textContent = 'Are you sure you want to delete this team? This action cannot be undone and will remove all team data.';

    window.currentAction = 'deleteTeam';
    window.currentActionData = teamId;

    console.log('Delete team action set:', teamId);
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
}

function removeMember(memberId, memberName) {
    document.getElementById('confirmModalTitle').textContent = 'Remove Team Member';
    document.getElementById('confirmModalMessage').textContent = 
        `Are you sure you want to remove ${memberName} from the team? This action cannot be undone.`;

    window.currentAction = 'removeMember';
    window.currentActionData = memberId;

    console.log('Remove member action set:', memberId, memberName);
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
}

function cancelInvitation(invitationId, userName) {
    document.getElementById('confirmModalTitle').textContent = 'Cancel Invitation';
    document.getElementById('confirmModalMessage').textContent = 
        `Are you sure you want to cancel the invitation sent to ${userName}?`;

    window.currentAction = 'cancelInvitation';
    window.currentActionData = invitationId;

    console.log('Cancel invitation action set:', invitationId, userName);
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
}
</script>
{% endblock %}